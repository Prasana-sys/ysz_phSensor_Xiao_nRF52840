<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YSZ pH Sensor — Web BLE</title>
<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 16px; background:#0f1724; color:#e6eef8; }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .card { background:#0b1220; border:1px solid #172033; border-radius:10px; padding:12px; margin-bottom:12px; box-shadow: 0 4px 14px rgba(2,6,23,0.6); }
  label { display:block; margin-top:8px; font-size:13px; color:#b6c7dc; }
  input[type="text"], input[type="number"] { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #223142; background:#07101b; color:#e6eef8; }
  .row { display:flex; gap:8px; }
  button { padding:8px 12px; border-radius:8px; background:#264b8a; border:none; color:white; cursor:pointer; }
  button.secondary { background:#2f3b46; }
  button.warn { background:#8a2b2b; }
  textarea { width:100%; height:220px; padding:8px; border-radius:8px; background:#07101b; color:#e6eef8; border:1px solid #223142; font-family: monospace; font-size:12px; }
  .small { font-size:12px; color:#98a9c0; }
  .flex-between { display:flex; justify-content:space-between; align-items:center; }
  .hidden { display:none; }
  .mode-pill { padding:6px 10px; border-radius:999px; background:#1f6f3e; color:#eafff0; font-weight:600; }
  .mode-pill.readout { background:#6b46c1; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; }
  .top-row { display:flex; gap:8px; margin-bottom:12px; align-items:center; }
  .uuid { font-family:monospace; font-size:12px; color:#87a0c6; }
  .status { font-size:13px; color:#cfe1ff; }
  .log-controls { margin-top:8px; display:flex; gap:8px; }
</style>
</head>
<body>
  <h1>YSZ pH Sensor — Web BLE Readout</h1>

  <div class="card top-row">
    <div style="flex:1">
      <div class="flex-between">
        <div>
          <div class="small">Device</div>
          <div id="deviceName">Not connected</div>
          <div class="small uuid" id="deviceUuid"></div>
        </div>
        <div>
          <div class="small">Mode</div>
          <div id="modeBadge" class="mode-pill">—</div>
        </div>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" class="secondary hidden">Disconnect</button>
    </div>
  </div>

  <div id="predeployPanel" class="card hidden">
    <div class="flex-between">
      <div><strong>Pre-deployment Mode</strong></div>
      <div class="small">Services: <span id="serviceList"></span></div>
    </div>

    <div style="margin-top:8px">
      <button id="readSettingsBtn" class="secondary">Read Current Settings</button>
    </div>

    <div style="margin-top:12px">
      <label>continuousScanningDeployment (0 or 1)</label>
      <input id="contScanInput" type="number" min="0" max="1" placeholder="leave blank to keep device value">

      <label>numberMeasurementsDeployment (uint32)</label>
      <input id="numMeasDeployInput" type="number" placeholder="leave blank to keep device value">

      <label>numberMeasurementsPreDeployment (uint32)</label>
      <input id="numMeasPreDeployInput" type="number" placeholder="leave blank to keep device value">

      <label>sampleIntervalDeployment (uint32 seconds)</label>
      <input id="sampleIntervalDeployInput" type="number" placeholder="leave blank to keep device value">

      <label>sampleIntervalPreDeployment (uint8 seconds)</label>
      <input id="sampleIntervalPreDeployInput" type="number" min="0" max="255" placeholder="leave blank to keep device value">
    </div>

    <div class="controls" style="margin-top:12px">
      <button id="saveSettingsBtn">Save Settings (send SAVE)</button>
      <button id="continueBtn" class="secondary">Continue to Measurements (send CONTINUE)</button>
      <button id="resetBtn" class="warn">Reset Settings to Defaults (send RESET)</button>
      <button id="pingBtn" class="secondary">Ping Device (send PING)</button>
    </div>

    <div class="small" style="margin-top:8px">
      * Leave a field blank to leave that value unchanged on the device.
    </div>
  </div>

  <div id="readoutPanel" class="card hidden">
    <div class="flex-between">
      <div><strong>BLE Readout Mode</strong></div>
      <div class="small">PMS Log Entry will stream into the Log below.</div>
    </div>

    <div style="margin-top:8px" class="controls">
      <button id="startTransferBtn">Start Transfer (send START DATA TRANSFER)</button>
      <button id="cmdPingBtn" class="secondary">Ping Device (send PING)</button>
    </div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div><strong>Live Log</strong></div>
      <div class="small status" id="connectionStatus">Disconnected</div>
    </div>
    <textarea id="logArea" readonly placeholder="No data yet..."></textarea>
    <div class="log-controls">
      <button id="downloadCsvBtn" class="secondary">Download CSV</button>
      <button id="clearLogBtn" class="secondary">Clear Log</button>
    </div>
  </div>

<script>
/*
  Web app for YSZ pH Sensor
  - Uses Web Bluetooth to connect to device and read/write characteristics
  UUIDs from user:
  PMS service: 019A2890-2324-7D95-8F76-8DE7146B560E
    Log Entry: 019A2896-2324-7D95-8F76-8DE7146B560E (Indicate)

  CS service: 019A2990-2324-7D95-8F76-8DE7146B560E
    Command: 019A2991-2324-7D95-8F76-8DE7146B560E (Write)
    continuousScanningDeployment: 019A2992-2324-7D95-8F76-8DE7146B560E (u8)
    numberMeasurementsDeployment: 019A2993-2324-7D95-8F76-8DE7146B560E (u32)
    numberMeasurementsPreDeployment: 019A2994-2324-7D95-8F76-8DE7146B560E (u32)
    sampleIntervalDeployment: 019A2995-2324-7D95-8F76-8DE7146B560E (u32)
    sampleIntervalPreDeployment: 019A2996-2324-7D95-8F76-8DE7146B560E (u8)
*/

const UUIDS = {
  PMS: '019a2890-2324-7d95-8f76-8de7146b560e',
  PMS_LOG: '019a2896-2324-7d95-8f76-8de7146b560e',
  CS: '019a2990-2324-7d95-8f76-8de7146b560e',
  CS_CMD: '019a2991-2324-7d95-8f76-8de7146b560e',
  CS_CONT_SCAN: '019a2992-2324-7d95-8f76-8de7146b560e',
  CS_NUM_MEAS_DEPLOY: '019a2993-2324-7d95-8f76-8de7146b560e',
  CS_NUM_MEAS_PREDEPLOY: '019a2994-2324-7d95-8f76-8de7146b560e',
  CS_SAMPLE_INTERVAL_DEPLOY: '019a2995-2324-7d95-8f76-8de7146b560e',
  CS_SAMPLE_INTERVAL_PREDEPLOY: '019a2996-2324-7d95-8f76-8de7146b560e'
};

// Command bytes (from your firmware)
const CMD = {
  SAVE_SETTINGS: 0x01,
  CONTINUE: 0x02,
  RESET: 0x03,
  PING: 0x04,
  START_TRANSFER: 0x12
};

let device = null;
let server = null;
let characteristics = {};
let logs = [];

// UI refs
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const deviceNameEl = document.getElementById('deviceName');
const deviceUuidEl = document.getElementById('deviceUuid');
const modeBadge = document.getElementById('modeBadge');
const serviceListEl = document.getElementById('serviceList');
const predeployPanel = document.getElementById('predeployPanel');
const readoutPanel = document.getElementById('readoutPanel');
const connectionStatus = document.getElementById('connectionStatus');
const logArea = document.getElementById('logArea');

const contScanInput = document.getElementById('contScanInput');
const numMeasDeployInput = document.getElementById('numMeasDeployInput');
const numMeasPreDeployInput = document.getElementById('numMeasPreDeployInput');
const sampleIntervalDeployInput = document.getElementById('sampleIntervalDeployInput');
const sampleIntervalPreDeployInput = document.getElementById('sampleIntervalPreDeployInput');

const readSettingsBtn = document.getElementById('readSettingsBtn');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const continueBtn = document.getElementById('continueBtn');
const resetBtn = document.getElementById('resetBtn');
const pingBtn = document.getElementById('pingBtn');

const startTransferBtn = document.getElementById('startTransferBtn');
const cmdPingBtn = document.getElementById('cmdPingBtn');

const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const clearLogBtn = document.getElementById('clearLogBtn');

// Connect button
connectBtn.addEventListener('click', async () => {
  try {
    await connectToDevice();
  } catch (e) {
    console.error(e);
    alert('Connection failed: ' + (e.message || e));
  }
});

// Disconnect
disconnectBtn.addEventListener('click', async () => {
  if (device && device.gatt.connected) {
    device.gatt.disconnect();
  }
  cleanup();
});

// Read settings
readSettingsBtn.addEventListener('click', async () => {
  await readCurrentSettings();
});

// Save settings
saveSettingsBtn.addEventListener('click', async () => {
  await writeSettingsAndSendCommand(CMD.SAVE_SETTINGS);
});

// Continue
continueBtn.addEventListener('click', async () => {
  await writeCommand(CMD.CONTINUE);
});

// Reset
resetBtn.addEventListener('click', async () => {
  if (!confirm('Reset device settings to defaults?')) return;
  await writeCommand(CMD.RESET);
});

// Ping
pingBtn.addEventListener('click', async () => {
  await writeCommand(CMD.PING);
});

// Readout mode: Start Transfer
startTransferBtn.addEventListener('click', async () => {
  await writeCommand(CMD.START_TRANSFER);
});

// Readout ping
cmdPingBtn.addEventListener('click', async () => {
  await writeCommand(CMD.PING);
});

// Download CSV
downloadCsvBtn.addEventListener('click', () => {
  downloadCSV();
});

// Clear log
clearLogBtn.addEventListener('click', () => {
  logs = [];
  renderLog();
});

async function connectToDevice() {
  connectionStatus.textContent = 'Connecting...';
  const opts = {
    filters: [
      // Prefer by name so user sees device by name; if you want to filter by services use UUIDs
      { namePrefix: 'YSZ' },
    ],
    optionalServices: [
      UUIDS.PMS,
      UUIDS.CS
    ]
  };

  device = await navigator.bluetooth.requestDevice(opts);
  device.addEventListener('gattserverdisconnected', onDisconnected);
  deviceNameEl.textContent = device.name || device.id;
  deviceUuidEl.textContent = device.id;

  server = await device.gatt.connect();
  connectionStatus.textContent = 'Connected';

  // Discover services & characteristics we care about
  await discoverServicesAndCharacteristics();
}

async function discoverServicesAndCharacteristics() {
  characteristics = {}; // reset
  serviceListEl.textContent = '';

  // Try to get PMS service
  let hasPMS = false, hasCS = false;
  try {
    const pmsService = await server.getPrimaryService(UUIDS.PMS);
    hasPMS = true;
    serviceListEl.textContent += 'PMS ';
    // Get Log Entry char
    try {
      const logChar = await pmsService.getCharacteristic(UUIDS.PMS_LOG);
      characteristics.pmsLog = logChar;
      // subscribe to notifications
      await startLogNotifications(logChar);
    } catch (e) {
      console.warn('PMS log char not found', e);
    }
  } catch (e) {
    console.warn('PMS service not found', e);
  }

  // Try to get CS service
  try {
    const csService = await server.getPrimaryService(UUIDS.CS);
    hasCS = true;
    serviceListEl.textContent += 'CS ';
    // discover cs characteristics — some modes may not expose all
    const charIds = [
      ['csCmd', UUIDS.CS_CMD],
      ['csContScan', UUIDS.CS_CONT_SCAN],
      ['csNumMeasDeploy', UUIDS.CS_NUM_MEAS_DEPLOY],
      ['csNumMeasPre', UUIDS.CS_NUM_MEAS_PREDEPLOY],
      ['csSampleIntervalDeploy', UUIDS.CS_SAMPLE_INTERVAL_DEPLOY],
      ['csSampleIntervalPre', UUIDS.CS_SAMPLE_INTERVAL_PREDEPLOY],
    ];
    for (const [name, uuid] of charIds) {
      try {
        const c = await csService.getCharacteristic(uuid);
        characteristics[name] = c;
      } catch (e) {
        // not present in this mode
      }
    }
  } catch (e) {
    console.warn('CS service not found', e);
  }

  // Decide mode:
  // If CS present AND all config characteristics are present => Pre-deployment
  const hasAllConfig =
    !!characteristics.csCmd &&
    !!characteristics.csContScan &&
    !!characteristics.csNumMeasDeploy &&
    !!characteristics.csNumMeasPre &&
    !!characteristics.csSampleIntervalDeploy &&
    !!characteristics.csSampleIntervalPre;

  if (hasAllConfig) {
    enterPreDeploymentMode();
  } else {
    enterReadoutMode();
  }

  // UI toggles
  connectBtn.classList.add('hidden');
  disconnectBtn.classList.remove('hidden');
}

function enterPreDeploymentMode() {
  modeBadge.textContent = 'Pre-deployment';
  modeBadge.classList.remove('readout');
  modeBadge.classList.add('mode-pill');
  predeployPanel.classList.remove('hidden');
  readoutPanel.classList.add('hidden');
  connectionStatus.textContent = 'Connected (Pre-deployment)';
  console.log('Entered Pre-deployment mode');
}

function enterReadoutMode() {
  modeBadge.textContent = 'BLE Readout';
  modeBadge.classList.add('readout');
  predeployPanel.classList.add('hidden');
  readoutPanel.classList.remove('hidden');
  connectionStatus.textContent = 'Connected (Readout)';
  console.log('Entered Readout mode');
}

async function startLogNotifications(logChar) {
  if (!logChar) return;
  try {
    await logChar.startNotifications();
    logChar.addEventListener('characteristicvaluechanged', (ev) => {
      const value = ev.target.value;
      // decode as UTF-8 string (device indicates CSV lines)
      const text = dataViewToString(value);
      handleIncomingLogText(text);
    });
    console.log('Subscribed to log notifications');
  } catch (e) {
    console.warn('Could not start notifications on log char', e);
  }
}

function dataViewToString(dataView) {
  // convert DataView to UTF-8 string
  const decoder = new TextDecoder('utf-8');
  const arr = new Uint8Array(dataView.buffer, dataView.byteOffset, dataView.byteLength);
  return decoder.decode(arr);
}

function handleIncomingLogText(text) {
  // The device sends lines with trailing newline like "hh:mm:ss,1.234,...\n"
  // Sometimes chunking may occur; we append and split by newline.
  appendToLogBuffer(text);
}

let partialLine = '';
function appendToLogBuffer(chunk) {
  // accumulate
  const combined = partialLine + chunk;
  const parts = combined.split('\\n');
  // if last element doesn't end in newline, keep it as partial
  partialLine = parts.pop();
  for (const line of parts) {
    if (line.trim().length === 0) continue;
    // Some devices send "NO DATA" as a message to indicate no further data - we'll add it as well
    logs.push(line);
  }
  renderLog();
}

// Render log to textarea
function renderLog() {
  if (logs.length === 0) {
    logArea.value = '';
    return;
  }
  logArea.value = logs.join('\\n') + (partialLine ? '\\n' + partialLine : '');
  logArea.scrollTop = logArea.scrollHeight;
}

// Read current settings from config characteristics (pre-deploy)
async function readCurrentSettings() {
  if (!characteristics.csContScan) {
    alert('Config characteristics not available on this device.');
    return;
  }
  try {
    // continuousScanningDeployment (u8)
    const cont = await characteristics.csContScan.readValue();
    const contVal = cont.getUint8(0);
    contScanInput.value = contVal ? 1 : 0;

    // numberMeasurementsDeployment (u32 little-endian)
    const nmd = await characteristics.csNumMeasDeploy.readValue();
    const nmdVal = nmd.getUint32(0, true);
    numMeasDeployInput.value = nmdVal;

    const nmp = await characteristics.csNumMeasPre.readValue();
    const nmpVal = nmp.getUint32(0, true);
    numMeasPreDeployInput.value = nmpVal;

    const sid = await characteristics.csSampleIntervalDeploy.readValue();
    const sidVal = sid.getUint32(0, true);
    sampleIntervalDeployInput.value = sidVal;

    const sip = await characteristics.csSampleIntervalPre.readValue();
    const sipVal = sip.getUint8(0);
    sampleIntervalPreDeployInput.value = sipVal;

    alert('Settings read and populated in the form.');
  } catch (e) {
    console.error('Error reading settings:', e);
    alert('Failed to read settings: ' + (e.message || e));
  }
}

// Write changed settings (only fields non-empty) and then optionally send command
async function writeSettingsAndSendCommand(cmdByte) {
  if (!characteristics.csCmd) {
    alert('Command characteristic not available.');
    return;
  }

  try {
    // For each field, if not blank, write to corresponding char
    if (contScanInput.value !== '') {
      const v = contScanInput.value == '1' ? 1 : 0;
      const buf = new Uint8Array([v]);
      await characteristics.csContScan.writeValue(buf);
      console.log('Wrote contScan', v);
    }
    if (numMeasDeployInput.value !== '') {
      const buf = new ArrayBuffer(4);
      new DataView(buf).setUint32(0, Number(numMeasDeployInput.value), true);
      await characteristics.csNumMeasDeploy.writeValue(buf);
      console.log('Wrote numMeasDeploy', numMeasDeployInput.value);
    }
    if (numMeasPreDeployInput.value !== '') {
      const buf = new ArrayBuffer(4);
      new DataView(buf).setUint32(0, Number(numMeasPreDeployInput.value), true);
      await characteristics.csNumMeasPre.writeValue(buf);
      console.log('Wrote numMeasPre', numMeasPreDeployInput.value);
    }
    if (sampleIntervalDeployInput.value !== '') {
      const buf = new ArrayBuffer(4);
      new DataView(buf).setUint32(0, Number(sampleIntervalDeployInput.value), true);
      await characteristics.csSampleIntervalDeploy.writeValue(buf);
      console.log('Wrote sampleIntervalDeploy', sampleIntervalDeployInput.value);
    }
    if (sampleIntervalPreDeployInput.value !== '') {
      const v = Number(sampleIntervalPreDeployInput.value) & 0xFF;
      const buf = new Uint8Array([v]);
      await characteristics.csSampleIntervalPre.writeValue(buf);
      console.log('Wrote sampleIntervalPre', v);
    }

    // After writing, send command (e.g., SAVE)
    await writeCommand(cmdByte);
    alert('Settings saved and command sent.');
  } catch (e) {
    console.error('Error writing settings:', e);
    alert('Failed to write settings: ' + (e.message || e));
  }
}

// Write a single byte command to csCmd
async function writeCommand(cmdByte) {
  if (!characteristics.csCmd) {
    alert('Command characteristic not available.');
    return;
  }
  try {
    const buf = new Uint8Array([cmdByte]);
    await characteristics.csCmd.writeValue(buf);
    console.log('Wrote command', cmdByte);
  } catch (e) {
    console.error('Error writing command:', e);
    alert('Failed to send command: ' + (e.message || e));
  }
}

function onDisconnected() {
  console.log('Device disconnected');
  cleanup();
}

function cleanup() {
  deviceNameEl.textContent = 'Not connected';
  deviceUuidEl.textContent = '';
  connectionStatus.textContent = 'Disconnected';
  modeBadge.textContent = '—';
  predeployPanel.classList.add('hidden');
  readoutPanel.classList.add('hidden');
  connectBtn.classList.remove('hidden');
  disconnectBtn.classList.add('hidden');
  device = null;
  server = null;
  characteristics = {};
}

// Download CSV from logs array
function downloadCSV() {
  if (logs.length === 0) {
    alert('No logs to download');
    return;
  }
  const csvContent = logs.join('\\n') + '\\n';
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const ts = new Date().toISOString().replace(/[:.]/g,'-');
  a.href = url;
  a.download = `ysz_ph_logs_${ts}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

// Prevent losing logs if page reloads? Not implemented; logs are ephemeral in this simple app.

</script>
</body>
</html>
