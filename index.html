<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>YSZ pH Sensor — Web BLE</title>
<style>
  body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 16px; background:#ffffff; color:#1a1a1a; }
  h1 { font-size: 20px; margin-bottom: 8px; }
  .card { background:#f9fafb; border:1px solid #d1d5db; border-radius:10px; padding:12px; margin-bottom:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05); }
  label { display:block; margin-top:8px; font-size:13px; color:#333; }
  input[type="text"], input[type="number"] { width:100%; padding:8px; margin-top:6px; border-radius:6px; border:1px solid #ccc; background:#fff; color:#111; }
  .row { display:flex; gap:8px; }
  button { padding:8px 12px; border-radius:8px; background:#2563eb; border:none; color:white; cursor:pointer; }
  button.secondary { background:#6b7280; }
  button.warn { background:#dc2626; }
  textarea { width:100%; height:220px; padding:8px; border-radius:8px; background:#f3f4f6; color:#111; border:1px solid #ccc; font-family: monospace; font-size:12px; }
  .small { font-size:12px; color:#555; }
  .flex-between { display:flex; justify-content:space-between; align-items:center; }
  .hidden { display:none; }
  .mode-pill { padding:6px 10px; border-radius:999px; background:#16a34a; color:#fff; font-weight:600; }
  .mode-pill.readout { background:#7c3aed; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; }
  .top-row { display:flex; gap:8px; margin-bottom:12px; align-items:center; }
  .uuid { font-family:monospace; font-size:12px; color:#6b7280; }
  .status { font-size:13px; color:#374151; }
  .log-controls { margin-top:8px; display:flex; gap:8px; }
</style>
</head>
<body>
  <h1>YSZ pH Sensor — Web BLE Readout</h1>

  <div class="card top-row">
    <div style="flex:1">
      <div class="flex-between">
        <div>
          <div class="small">Device</div>
          <div id="deviceName">Not connected</div>
          <div class="small uuid" id="deviceUuid"></div>
        </div>
        <div>
          <div class="small">Mode</div>
          <div id="modeBadge" class="mode-pill">—</div>
        </div>
      </div>
    </div>

    <div style="display:flex;flex-direction:column;gap:8px">
      <button id="connectBtn">Connect</button>
      <button id="disconnectBtn" class="secondary hidden">Disconnect</button>
    </div>
  </div>

  <div id="predeployPanel" class="card hidden">
    <div class="flex-between">
      <div><strong>Pre-deployment Mode</strong></div>
      <div class="small">Services: <span id="serviceList"></span></div>
    </div>

    <div style="margin-top:8px">
      <button id="readSettingsBtn" class="secondary">Read Current Settings</button>
    </div>

    <div style="margin-top:12px">
      <div class="row">
        <div style="flex:1">
          <label>Scanning Mode</label>
          <select id="contScanSelect" style="width:70%;">
            <option value="0">Limited Scanning</option>
            <option value="1">Continuous Scanning</option>
          </select>
        </div>
        <div style="flex:1">
          <label>startDelayDeployment (uint32 seconds)</label>
          <input id="startDelayDeployInput" type="number" min="0" max="86400" style="width:70%;" placeholder="0–86400 seconds">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>numberMeasurementsDeployment (uint32)</label>
          <input id="numMeasDeployInput" type="number" min="1" max="100000" style="width:70%;" placeholder="1–100000">
        </div>
        <div style="flex:1">
          <label>sampleIntervalDeployment (uint32 seconds)</label>
          <input id="sampleIntervalDeployInput" type="number" min="1" max="3600" style="width:70%;" placeholder="1–3600 seconds">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>numberMeasurementsPreDeployment (uint32)</label>
          <input id="numMeasPreDeployInput" type="number" min="1" max="100000" style="width:70%;" placeholder="1–100000">
        </div>
        <div style="flex:1">
          <label>sampleIntervalPreDeployment (uint8 seconds)</label>
          <input id="sampleIntervalPreDeployInput" type="number" min="1" max="255" style="width:70%;" placeholder="1–255 seconds">
        </div>
      </div>
    </div>

    <div class="controls" style="margin-top:12px">
      <button id="saveSettingsBtn">Save Settings (send SAVE)</button>
      <button id="continueBtn" class="secondary">Continue to Measurements (send CONTINUE)</button>
      <button id="resetBtn" class="warn">Reset Settings (send RESET)</button>
      <button id="pingBtn" class="secondary">Ping Device (send PING)</button>
    </div>

    <div class="small" style="margin-top:8px">
      * Leave a field blank to leave that value unchanged on the device.
    </div>
  </div>

  <div id="readoutPanel" class="card hidden">
    <div class="flex-between">
      <div><strong>BLE Readout Mode</strong></div>
      <div class="small">PMS Log Entry will stream into the Log below.</div>
    </div>

    <div style="margin-top:8px" class="controls">
      <button id="startTransferBtn">Start Transfer (send START DATA TRANSFER)</button>
      <button id="cmdPingBtn" class="secondary">Ping Device (send PING)</button>
      <button id="deleteLogBtn" class="warn">Delete Log File (send DELETE_LOG)</button>
    </div>
  </div>

  <div class="card">
    <div class="flex-between">
      <div><strong>Live Log</strong></div>
      <div class="small status" id="connectionStatus">Disconnected</div>
    </div>
    <textarea id="logArea" readonly placeholder="No data yet..."></textarea>
    <div class="log-controls">
      <button id="downloadCsvBtn" class="secondary">Download CSV</button>
      <button id="clearLogBtn" class="secondary">Clear Log</button>
    </div>
  </div>

<script>
/*
  YSZ pH Sensor Web Bluetooth App
  - Pre-deployment: PMS + CS services (Command in CS)
  - BLE Readout: PMS only (Command in PMS)
*/

const UUIDS = {
  PMS: '019a2890-2324-7d95-8f76-8de7146b560e',
  PMS_LOG: '019a2896-2324-7d95-8f76-8de7146b560e',
  PMS_CMD: '019a2991-2324-7d95-8f76-8de7146b560e',
  CS: '019a2990-2324-7d95-8f76-8de7146b560e',
  CS_CMD: '019a2991-2324-7d95-8f76-8de7146b560e',
  CS_CONT_SCAN: '019a2992-2324-7d95-8f76-8de7146b560e',
  CS_NUM_MEAS_DEPLOY: '019a2993-2324-7d95-8f76-8de7146b560e',
  CS_NUM_MEAS_PREDEPLOY: '019a2994-2324-7d95-8f76-8de7146b560e',
  CS_SAMPLE_INTERVAL_DEPLOY: '019a2995-2324-7d95-8f76-8de7146b560e',
  CS_SAMPLE_INTERVAL_PREDEPLOY: '019a2996-2324-7d95-8f76-8de7146b560e',
  CS_START_DELAY_DEPLOY: '019a2997-2324-7d95-8f76-8de7146b560e'
};

// Command bytes (from your firmware)
const CMD = {
  SAVE_SETTINGS: 0x01,
  CONTINUE: 0x02,
  RESET: 0x03,
  PING: 0x04,
  START_TRANSFER: 0x12,
  DELETE_LOG: 0x13
};

let device = null, server = null, characteristics = {}, logs = [];

const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const deviceNameEl = document.getElementById('deviceName');
const deviceUuidEl = document.getElementById('deviceUuid');
const modeBadge = document.getElementById('modeBadge');
const serviceListEl = document.getElementById('serviceList');
const predeployPanel = document.getElementById('predeployPanel');
const readoutPanel = document.getElementById('readoutPanel');
const connectionStatus = document.getElementById('connectionStatus');
const logArea = document.getElementById('logArea');

const contScanSelect = document.getElementById('contScanSelect');
const numMeasDeployInput = document.getElementById('numMeasDeployInput');
const numMeasPreDeployInput = document.getElementById('numMeasPreDeployInput');
const sampleIntervalDeployInput = document.getElementById('sampleIntervalDeployInput');
const sampleIntervalPreDeployInput = document.getElementById('sampleIntervalPreDeployInput');

const readSettingsBtn = document.getElementById('readSettingsBtn');
const saveSettingsBtn = document.getElementById('saveSettingsBtn');
const continueBtn = document.getElementById('continueBtn');
const resetBtn = document.getElementById('resetBtn');
const pingBtn = document.getElementById('pingBtn');
const startTransferBtn = document.getElementById('startTransferBtn');
const cmdPingBtn = document.getElementById('cmdPingBtn');
const downloadCsvBtn = document.getElementById('downloadCsvBtn');
const clearLogBtn = document.getElementById('clearLogBtn');

connectBtn.onclick = async () => { try { await connectToDevice(); } catch(e){ alert('Connection failed: '+e); } };
disconnectBtn.onclick = () => { if(device && device.gatt.connected) device.gatt.disconnect(); cleanup(); };
readSettingsBtn.onclick = readCurrentSettings;
saveSettingsBtn.onclick = () => writeSettingsAndSendCommand(CMD.SAVE_SETTINGS);
continueBtn.onclick = () => writeCommand(CMD.CONTINUE);
resetBtn.onclick = () => { if(confirm('Reset device settings?')) writeCommand(CMD.RESET); };
pingBtn.onclick = pingDevice;
startTransferBtn.onclick = () => writeCommand(CMD.START_TRANSFER);
deleteLogBtn.onclick = () => { if(confirm('Delete stored log file from flash?')) writeCommand(CMD.DELETE_LOG); };
cmdPingBtn.onclick = pingDevice;
downloadCsvBtn.onclick = downloadCSV;
clearLogBtn.onclick = () => { logs=[]; renderLog(); };

async function connectToDevice(){
  connectionStatus.textContent='Connecting...';
  const opts={filters:[{namePrefix:'YSZ'}],optionalServices:[UUIDS.PMS,UUIDS.CS]};
  device=await navigator.bluetooth.requestDevice(opts);
  device.addEventListener('gattserverdisconnected',onDisconnected);
  deviceNameEl.textContent=device.name||device.id;
  deviceUuidEl.textContent=device.id;
  server=await device.gatt.connect();
  connectionStatus.textContent='Connected';
  await discoverServicesAndCharacteristics();
}

async function discoverServicesAndCharacteristics(){
  characteristics={}; serviceListEl.textContent='';
  let hasPMS=false, hasCS=false;

  // PMS service
  try{
    const pms=await server.getPrimaryService(UUIDS.PMS);
    hasPMS=true; serviceListEl.textContent+='PMS ';
    const logChar=await pms.getCharacteristic(UUIDS.PMS_LOG);
    characteristics.pmsLog=logChar;
    await startLogNotifications(logChar);
    console.log('Found PMS Log Entry characteristic');

    try{
      const cmd=await pms.getCharacteristic(UUIDS.PMS_CMD);
      characteristics.csCmd=cmd;
      console.log('Found Command char inside PMS (Readout mode)');
    }catch(e){ console.log('No Command char in PMS — likely Pre-deployment mode'); }

  }catch(e){ console.warn('PMS service not found',e); }

  // CS service (only pre-deploy)
  try{
    const cs=await server.getPrimaryService(UUIDS.CS);
    hasCS=true; serviceListEl.textContent+='CS ';
    const charIds=[
      ['csCmd',UUIDS.CS_CMD],
      ['csContScan',UUIDS.CS_CONT_SCAN],
      ['csStartDelayDeploy',UUIDS.CS_START_DELAY_DEPLOY],
      ['csNumMeasDeploy',UUIDS.CS_NUM_MEAS_DEPLOY],
      ['csNumMeasPre',UUIDS.CS_NUM_MEAS_PREDEPLOY],
      ['csSampleIntervalDeploy',UUIDS.CS_SAMPLE_INTERVAL_DEPLOY],
      ['csSampleIntervalPre',UUIDS.CS_SAMPLE_INTERVAL_PREDEPLOY]
    ];
    for(const [n,u] of charIds){
      try{ characteristics[n]=await cs.getCharacteristic(u); console.log('Found',n);}
      catch(e){ console.log('Missing',n);}
    }
  }catch(e){ console.log('CS service not found (expected in readout)'); }

  // Decide mode
  const hasConfig = !!characteristics.csContScan;
  if(hasConfig && hasCS) enterPreDeploymentMode();
  else if(hasPMS && characteristics.csCmd) enterReadoutMode();
  else{ alert('Device structure not recognized'); cleanup(); }

  connectBtn.classList.add('hidden'); disconnectBtn.classList.remove('hidden');
}

function enterPreDeploymentMode(){
  modeBadge.textContent='Pre-deployment';
  modeBadge.classList.remove('readout');
  predeployPanel.classList.remove('hidden');
  readoutPanel.classList.add('hidden');
  connectionStatus.textContent='Connected (Pre-deployment)';
}
function enterReadoutMode(){
  modeBadge.textContent='BLE Readout';
  modeBadge.classList.add('readout');
  predeployPanel.classList.add('hidden');
  readoutPanel.classList.remove('hidden');
  connectionStatus.textContent='Connected (Readout)';
}

async function startLogNotifications(char){
  await char.startNotifications();
  char.addEventListener('characteristicvaluechanged',ev=>{
    const text=new TextDecoder().decode(new Uint8Array(ev.target.value.buffer));
    handleIncomingLogText(text);
  });
}
let partialLine='';
function handleIncomingLogText(text){
  const combined=partialLine+text;
  const parts=combined.split('\n');
  partialLine=parts.pop();
  for(const line of parts){ if(line.trim()) logs.push(line); }
  renderLog();
}
function renderLog(){
  logArea.value=logs.join('\n')+(partialLine?'\n'+partialLine:'');
  logArea.scrollTop=logArea.scrollHeight;
}

async function readCurrentSettings(){
  if(!characteristics.csContScan){alert('Config not available');return;}
  try{
    contScanSelect.value = (await characteristics.csContScan.readValue()).getUint8(0);
    startDelayDeployInput.value = (await characteristics.csStartDelayDeploy.readValue()).getUint32(0,true);
    numMeasDeployInput.value=(await characteristics.csNumMeasDeploy.readValue()).getUint32(0,true);
    numMeasPreDeployInput.value=(await characteristics.csNumMeasPre.readValue()).getUint32(0,true);
    sampleIntervalDeployInput.value=(await characteristics.csSampleIntervalDeploy.readValue()).getUint32(0,true);
    sampleIntervalPreDeployInput.value=(await characteristics.csSampleIntervalPre.readValue()).getUint8(0);
    alert('Settings read');
  }catch(e){ alert('Read failed:'+e); }
}

async function writeSettingsAndSendCommand(cmdByte){
  try{
    await characteristics.csContScan.writeValue(Uint8Array.of(Number(contScanSelect.value)));
    if(startDelayDeployInput.value!==''){const b=new ArrayBuffer(4);new DataView(b).setUint32(0,Number(startDelayDeployInput.value),true);await characteristics.csStartDelayDeploy.writeValue(b);}
    if(numMeasDeployInput.value!==''){const b=new ArrayBuffer(4);new DataView(b).setUint32(0,Number(numMeasDeployInput.value),true);await characteristics.csNumMeasDeploy.writeValue(b);}
    if(numMeasPreDeployInput.value!==''){const b=new ArrayBuffer(4);new DataView(b).setUint32(0,Number(numMeasPreDeployInput.value),true);await characteristics.csNumMeasPre.writeValue(b);}
    if(sampleIntervalDeployInput.value!==''){const b=new ArrayBuffer(4);new DataView(b).setUint32(0,Number(sampleIntervalDeployInput.value),true);await characteristics.csSampleIntervalDeploy.writeValue(b);}
    if(sampleIntervalPreDeployInput.value!=='') await characteristics.csSampleIntervalPre.writeValue(Uint8Array.of(Number(sampleIntervalPreDeployInput.value)));
    await writeCommand(cmdByte);
    alert('Settings saved');
  }catch(e){ alert('Write failed:'+e); }
}

async function writeCommand(cmdByte){
  if(!characteristics.csCmd){alert('Command characteristic not available');return;}
  try{ await characteristics.csCmd.writeValue(Uint8Array.of(cmdByte)); console.log('Command',cmdByte,'sent'); }
  catch(e){ alert('Send failed:'+e); }
}

async function pingDevice() {
  const cmdChar = characteristics.csCmd;
  if (!cmdChar) {
    alert("Command characteristic not available!");
    return;
  }

  try {
    // Enable notifications (indications) on the Command characteristic
    await cmdChar.startNotifications();

    // Create a one-time listener for the indication
    const responsePromise = new Promise((resolve, reject) => {
      const timeout = setTimeout(() => {
        cmdChar.removeEventListener("characteristicvaluechanged", onResponse);
        reject(new Error("No ping response within 5 seconds"));
      }, 5000);

      function onResponse(event) {
        clearTimeout(timeout);
        cmdChar.removeEventListener("characteristicvaluechanged", onResponse);
        const value = event.target.value.getUint8(0);
        console.log("Ping response:", value);

        let msg;
        if (value === 0xAB)
          msg = "✅ Device pinged successfully — Pre-Deployment Mode (0xAB)";
        else if (value === 0xCD)
          msg = "✅ Device pinged successfully — BLE Readout Mode (0xCD)";
        else
          msg = `⚠️ Unknown ping response: 0x${value.toString(16).toUpperCase()}`;

        alert(msg);
        resolve();
      }

      cmdChar.addEventListener("characteristicvaluechanged", onResponse);
    });

    // Send Ping command (0x04)
    await cmdChar.writeValue(Uint8Array.of(0x04));
    console.log("Ping command sent, waiting for indication...");
    await responsePromise;
  } catch (err) {
    console.error("Ping failed:", err);
    alert("Ping failed: " + err.message);
  }
}

function onDisconnected(){ console.log('Disconnected'); cleanup(); }
function cleanup(){
  deviceNameEl.textContent='Not connected'; deviceUuidEl.textContent='';
  connectionStatus.textContent='Disconnected';
  predeployPanel.classList.add('hidden'); readoutPanel.classList.add('hidden');
  connectBtn.classList.remove('hidden'); disconnectBtn.classList.add('hidden');
  device=null; server=null; characteristics={};
}
function downloadCSV(){
  if(!logs.length){alert('No logs');return;}
  const blob=new Blob([logs.join('\n')+'\n'],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='ysz_ph_logs.csv';a.click();URL.revokeObjectURL(url);
}

function validateParams() {
  const startDelay = Number(startDelayDeployInput.value);
  const numDep = Number(numMeasDeployInput.value);
  const numPre = Number(numMeasPreDeployInput.value);
  const sampDep = Number(sampleIntervalDeployInput.value);
  const sampPre = Number(sampleIntervalPreDeployInput.value);

  const valid =
    (isNaN(startDelay) || (startDelay >= 0 && startDelay <= 86400)) &&
    (isNaN(numDep) || (numDep >= 1 && numDep <= 100000)) &&
    (isNaN(numPre) || (numPre >= 1 && numPre <= 100000)) &&
    (isNaN(sampDep) || (sampDep >= 1 && sampDep <= 3600)) &&
    (isNaN(sampPre) || (sampPre >= 1 && sampPre <= 255));

  saveSettingsBtn.disabled = !valid;
  saveSettingsBtn.style.opacity = valid ? "1" : "0.5";
  saveSettingsBtn.style.cursor = valid ? "pointer" : "not-allowed";
}

// monitor changes
[startDelayDeployInput, numMeasDeployInput, numMeasPreDeployInput,
 sampleIntervalDeployInput, sampleIntervalPreDeployInput]
.forEach(el => el.addEventListener("input", validateParams));

</script>
</body>
</html>
